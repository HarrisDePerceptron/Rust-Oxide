{% extends "base.html" %}

{% block title %}Sample Server | Docs{% endblock %}
{% block description %}Template docs for the Sample Server: CRUD router setup, filter syntax, and where to extend the stack.{% endblock %}

{% block content %}
      <main class="px-6 pb-16 pt-10 sm:px-10">
        <section class="fade-1 mx-auto max-w-3xl space-y-6">
          <div
            class="inline-flex items-center gap-3 rounded-full border border-black/10 bg-white/80 px-4 py-2 text-xs uppercase tracking-[0.3em] text-black/60 shadow-sm"
          >
            <span class="h-2 w-2 rounded-full bg-[color:var(--clay)]"></span>
            Template docs
          </div>
          <h1 class="font-display text-4xl leading-tight text-[color:var(--pine)] sm:text-5xl">
            A practical guide to shipping with this Rust template.
          </h1>
          <p class="text-base text-black/70 sm:text-lg">
            Use this page as your quick reference for wiring CRUD APIs, tuning
            filters, and knowing where to extend the core building blocks.
          </p>
          <div class="flex flex-wrap items-center gap-3 text-xs">
            <a
              class="rounded-full border border-black/10 bg-white/80 px-4 py-2 font-semibold uppercase tracking-[0.25em] text-[color:var(--pine)] transition hover:-translate-y-0.5"
              href="#getting-started"
            >
              Getting started
            </a>
            <a
              class="rounded-full border border-black/10 bg-white/80 px-4 py-2 font-semibold uppercase tracking-[0.25em] text-[color:var(--pine)] transition hover:-translate-y-0.5"
              href="#config"
            >
              Config
            </a>
            <a
              class="rounded-full border border-black/10 bg-white/80 px-4 py-2 font-semibold uppercase tracking-[0.25em] text-[color:var(--pine)] transition hover:-translate-y-0.5"
              href="#crud-router"
            >
              CRUD router
            </a>
            <a
              class="rounded-full border border-black/10 bg-white/80 px-4 py-2 font-semibold uppercase tracking-[0.25em] text-[color:var(--pine)] transition hover:-translate-y-0.5"
              href="#filters"
            >
              Filters
            </a>
            <a
              class="rounded-full border border-black/10 bg-white/80 px-4 py-2 font-semibold uppercase tracking-[0.25em] text-[color:var(--pine)] transition hover:-translate-y-0.5"
              href="#next-steps"
            >
              Next steps
            </a>
          </div>
        </section>

        <section id="getting-started" class="fade-2 mx-auto mt-14 max-w-3xl space-y-4">
          <p class="text-xs uppercase tracking-[0.3em] text-black/40">Getting started</p>
          <h2 class="font-display text-3xl text-[color:var(--pine)]">From entity to API in four steps.</h2>
          <p class="text-sm text-black/70">
            The minimum path is: define your SeaORM entity, add a DAO, implement a service,
            then mount a CRUD router. Each layer stays focused so you can iterate quickly.
          </p>
          <div class="rounded-2xl border border-black/10 bg-white/90 p-4 text-sm text-black/70">
            <ol class="list-decimal list-inside space-y-1">
              <li>Define entity in <span class="font-semibold">src/db/entities/</span></li>
              <li>Add DAO in <span class="font-semibold">src/db/dao/</span></li>
              <li>Implement <span class="font-semibold">CrudService</span> in <span class="font-semibold">src/services/</span></li>
              <li>Mount <span class="font-semibold">CrudApiRouter</span> in <span class="font-semibold">src/routes/</span></li>
            </ol>
          </div>
          <div class="rounded-2xl border border-black/10 bg-white/90 p-4 text-xs text-black/70">
            <p class="font-semibold text-[color:var(--pine)]">Step 1: Entity</p>
            <pre class="mt-3 overflow-x-auto rounded-xl bg-[color:var(--mist)] p-3 text-xs text-[color:var(--pine)]"><code>// src/db/entities/todo_list.rs
use base_entity_derive::base_entity;
use sea_orm::entity::prelude::*;

#[base_entity]
#[sea_orm::model]
#[derive(Clone, Debug, PartialEq, Eq, serde::Serialize, serde::Deserialize, DeriveEntityModel)]
#[sea_orm(table_name = "todo_lists")]
pub struct Model {
    pub title: String,
    #[sea_orm(default_value = 0)]
    pub score: i32,
    #[sea_orm(has_many)]
    pub items: HasMany<super::todo_item::Entity>,
}

impl ActiveModelBehavior for ActiveModel {}</code></pre>
          </div>
          <div class="rounded-2xl border border-black/10 bg-white/90 p-4 text-xs text-black/70">
            <p class="font-semibold text-[color:var(--pine)]">Step 2: DAO</p>
            <pre class="mt-3 overflow-x-auto rounded-xl bg-[color:var(--mist)] p-3 text-xs text-[color:var(--pine)]"><code>// src/db/dao/todo_dao.rs
use sea_orm::DatabaseConnection;
use crate::db::dao::DaoBase;
use crate::db::entities::prelude::TodoList;

#[derive(Clone)]
pub struct TodoDao {
    db: DatabaseConnection,
}

impl DaoBase for TodoDao {
    type Entity = TodoList;

    fn from_db(db: DatabaseConnection) -> Self {
        Self { db }
    }

    fn db(&self) -> &DatabaseConnection {
        &self.db
    }
}</code></pre>
          </div>
          <div class="rounded-2xl border border-black/10 bg-white/90 p-4 text-xs text-black/70">
            <p class="font-semibold text-[color:var(--pine)]">Step 3: Service</p>
            <pre class="mt-3 overflow-x-auto rounded-xl bg-[color:var(--mist)] p-3 text-xs text-[color:var(--pine)]"><code>// src/services/todo_service.rs
use crate::db::dao::TodoDao;
use crate::services::crud_service::CrudService;

#[derive(Clone)]
pub struct TodoService {
    todo_dao: TodoDao,
}

impl TodoService {
    pub fn new(todo_dao: TodoDao) -> Self {
        Self { todo_dao }
    }
}

impl CrudService for TodoService {
    type Dao = TodoDao;

    fn dao(&self) -> &Self::Dao {
        &self.todo_dao
    }
}</code></pre>
          </div>
          <div class="rounded-2xl border border-black/10 bg-white/90 p-4 text-xs text-black/70">
            <p class="font-semibold text-[color:var(--pine)]">Step 4: Router</p>
            <pre class="mt-3 overflow-x-auto rounded-xl bg-[color:var(--mist)] p-3 text-xs text-[color:var(--pine)]"><code>// src/routes/todo_crud.rs
use std::sync::Arc;
use axum::Router;
use crate::db::dao::DaoContext;
use crate::routes::base_api_router::CrudApiRouter;
use crate::services::todo_service::TodoService;
use crate::state::AppState;

const BASE_PATH: &str = "/todo-crud";

pub fn router(state: Arc<AppState>) -> Router {
    let daos = DaoContext::new(&state.db);
    let service = TodoService::new(daos.todo());
    CrudApiRouter::new(service, BASE_PATH).router().with_state(state)
}</code></pre>
          </div>
        </section>

        <section id="project-structure" class="fade-2 mx-auto mt-14 max-w-3xl space-y-4">
          <p class="text-xs uppercase tracking-[0.3em] text-black/40">Project structure</p>
          <h2 class="font-display text-3xl text-[color:var(--pine)]">Know where to look first.</h2>
          <p class="text-sm text-black/70">
            This tree highlights the core modules you will touch most when extending the template.
          </p>
          <div class="rounded-3xl border border-black/10 bg-white/95 p-6 shadow-xl shadow-black/5">
            <pre class="overflow-x-auto rounded-2xl bg-[color:var(--mist)] p-4 text-xs text-[color:var(--pine)]"><code># repo root (key modules)
src/
  main.rs                 # bootstraps config, state, logging, router
  config.rs               # env-driven settings
  state.rs                # shared AppState (config, jwt keys, db)
  routes/                 # API + HTML routes
    base_api_router.rs    # CRUD router builder
    public.rs             # landing + docs + routes views
    auth.rs               # register/login/refresh
    protected.rs          # /me route
    admin.rs              # /admin stats
  services/               # business logic layer
    crud_service.rs       # filter parsing + list helpers
  db/
    entities/             # SeaORM entities (schema)
    dao/                  # data access objects
views/
  base.html               # shared layout
  docs.html               # docs page</code></pre>
          </div>
        </section>

        <section id="auth" class="fade-2 mx-auto mt-14 max-w-3xl space-y-4">
          <p class="text-xs uppercase tracking-[0.3em] text-black/40">JWT auth</p>
          <h2 class="font-display text-3xl text-[color:var(--pine)]">Register, get a token, protect routes.</h2>
          <p class="text-sm text-black/70">
            The auth router provides <span class="font-semibold">/register</span>,
            <span class="font-semibold">/login</span>, and <span class="font-semibold">/refresh</span>.
            Use the access token as a Bearer token to call protected endpoints.
          </p>
          <div class="rounded-3xl border border-black/10 bg-white/95 p-6 shadow-xl shadow-black/5">
            <p class="text-xs uppercase tracking-[0.3em] text-black/50">Get tokens</p>
            <pre class="mt-4 overflow-x-auto rounded-2xl bg-[color:var(--mist)] p-4 text-xs text-[color:var(--pine)]"><code># register
curl -X POST http://localhost:3000/register \\
  -H "Content-Type: application/json" \\
  -d '{"email":"you@example.com","password":"password123"}'

# login
curl -X POST http://localhost:3000/login \\
  -H "Content-Type: application/json" \\
  -d '{"email":"you@example.com","password":"password123"}'</code></pre>
          </div>
          <div class="rounded-3xl border border-black/10 bg-white/95 p-6 shadow-xl shadow-black/5">
            <p class="text-xs uppercase tracking-[0.3em] text-black/50">Call a protected route</p>
            <pre class="mt-4 overflow-x-auto rounded-2xl bg-[color:var(--mist)] p-4 text-xs text-[color:var(--pine)]"><code># /me is protected
curl http://localhost:3000/me \\
  -H "Authorization: Bearer $ACCESS_TOKEN"</code></pre>
          </div>
          <div class="rounded-3xl border border-black/10 bg-white/95 p-6 shadow-xl shadow-black/5">
            <p class="text-xs uppercase tracking-[0.3em] text-black/50">Minimal route protection</p>
            <pre class="mt-4 overflow-x-auto rounded-2xl bg-[color:var(--mist)] p-4 text-xs text-[color:var(--pine)]"><code>// src/routes/protected.rs
use axum::{Router, middleware, routing::get};
use std::sync::Arc;
use crate::auth::jwt::jwt_auth;
use crate::state::AppState;

pub fn router(state: Arc<AppState>) -> Router {
    Router::new()
        .route("/me", get(me))
        .route_layer(middleware::from_fn_with_state(state.clone(), jwt_auth))
        .with_state(state)
}</code></pre>
          </div>
          <div class="rounded-3xl border border-black/10 bg-white/95 p-6 shadow-xl shadow-black/5">
            <p class="text-xs uppercase tracking-[0.3em] text-black/50">Role-based protection</p>
            <pre class="mt-4 overflow-x-auto rounded-2xl bg-[color:var(--mist)] p-4 text-xs text-[color:var(--pine)]"><code>// src/routes/admin.rs
use axum::{Router, middleware, routing::get};
use std::sync::Arc;
use crate::auth::{jwt::jwt_auth, role_layer::RequireRoleLayer, Role};
use crate::state::AppState;

pub fn router(state: Arc<AppState>) -> Router {
    Router::new()
        .route("/admin/stats", get(admin_stats))
        .layer(RequireRoleLayer::new(Role::Admin))
        .route_layer(middleware::from_fn_with_state(state.clone(), jwt_auth))
        .with_state(state)
}</code></pre>
          </div>
        </section>

        <section id="config" class="fade-2 mx-auto mt-14 max-w-3xl space-y-4">
          <p class="text-xs uppercase tracking-[0.3em] text-black/40">Application config</p>
          <h2 class="font-display text-3xl text-[color:var(--pine)]">Extend AppConfig, then use it anywhere.</h2>
          <p class="text-sm text-black/70">
            Configuration lives in <span class="font-semibold">src/config.rs</span> and is loaded once
            at startup. The config is stored on <span class="font-semibold">AppState</span>, so routes
            and services can access it via the shared state.
          </p>
          <div class="rounded-3xl border border-black/10 bg-white/95 p-6 shadow-xl shadow-black/5">
            <p class="text-xs uppercase tracking-[0.3em] text-black/50">Step 1: add a field</p>
            <pre class="mt-4 overflow-x-auto rounded-2xl bg-[color:var(--mist)] p-4 text-xs text-[color:var(--pine)]"><code>// src/config.rs
#[derive(Debug, Clone)]
pub struct AppConfig {
    // ...
    pub app_name: String,
}

impl AppConfig {
    pub fn from_env() -> Result<Self> {
        // ...
        let app_name = std::env::var("APP_NAME")
            .unwrap_or_else(|_| "Sample Server".to_string());
        Ok(Self {
            // ...
            app_name,
        })
    }
}</code></pre>
          </div>
          <div class="rounded-3xl border border-black/10 bg-white/95 p-6 shadow-xl shadow-black/5">
            <p class="text-xs uppercase tracking-[0.3em] text-black/50">Step 2: read in routes</p>
            <pre class="mt-4 overflow-x-auto rounded-2xl bg-[color:var(--mist)] p-4 text-xs text-[color:var(--pine)]"><code>// src/routes/public.rs
use axum::extract::State;
use std::sync::Arc;
use crate::state::AppState;

async fn handler(State(state): State<Arc<AppState>>) {
    let name = &state.config.app_name;
    // use name in your response
}</code></pre>
          </div>
          <div class="rounded-3xl border border-black/10 bg-white/95 p-6 shadow-xl shadow-black/5">
            <p class="text-xs uppercase tracking-[0.3em] text-black/50">Step 3: use in services</p>
            <pre class="mt-4 overflow-x-auto rounded-2xl bg-[color:var(--mist)] p-4 text-xs text-[color:var(--pine)]"><code>// src/services/auth_service.rs
pub async fn seed_admin(&self, cfg: &AppConfig) -> anyhow::Result<()> {
    if let Some(existing) = self.user_dao.find_by_email(&cfg.admin_email).await? {
        tracing::info!("admin user already present: {}", existing.email);
        return Ok(());
    }
    // ...
    Ok(())
}</code></pre>
          </div>
        </section>

        <section id="crud-router" class="fade-2 mx-auto mt-14 max-w-3xl space-y-4">
          <p class="text-xs uppercase tracking-[0.3em] text-black/40">CRUD router</p>
          <h2 class="font-display text-3xl text-[color:var(--pine)]">Wrap a service, expose CRUD JSON.</h2>
          <p class="text-sm text-black/70">
            The file <span class="font-semibold">src/routes/base_api_router.rs</span> provides
            <span class="font-semibold">CrudApiRouter</span>. Hand it a service that implements
            <span class="font-semibold">CrudService</span> and a base path, and you get five
            JSON endpoints by default.
          </p>
          <div class="rounded-3xl border border-black/10 bg-white/95 p-6 shadow-xl shadow-black/5">
            <p class="text-xs uppercase tracking-[0.3em] text-black/50">Quick setup</p>
            <pre
              class="mt-4 overflow-x-auto rounded-2xl bg-[color:var(--mist)] p-4 text-xs text-[color:var(--pine)]"
            ><code>// src/routes/todo_crud.rs
use crate::db::dao::DaoContext;
use crate::routes::base_api_router::{CrudApiRouter, Method};
use crate::services::todo_service::TodoService;

let daos = DaoContext::new(&state.db);
let service = TodoService::new(daos.todo());
let router = CrudApiRouter::new(service, "/todo-crud")
    .set_allowed_methods(&[
        Method::Create,
        Method::List,
        Method::Get,
        Method::Patch,
        Method::Delete,
    ])
    .router();</code></pre>
            <p class="mt-4 text-sm text-black/60">
              Keep handlers thin. Customize list ordering and filtering through the service
              and override list hooks in the router if needed.
            </p>
          </div>
          <div class="rounded-2xl border border-black/10 bg-white/90 p-4 text-xs text-black/70">
            <p class="font-semibold text-[color:var(--pine)]">Default endpoints</p>
            <pre class="mt-3 overflow-x-auto rounded-xl bg-[color:var(--mist)] p-3 text-xs text-[color:var(--pine)]"><code># http
POST /base
GET /base
GET /base/{id}
PATCH /base/{id}
DELETE /base/{id}</code></pre>
            <p class="mt-2 text-black/50">IDs are UUIDs in this template.</p>
          </div>
          <div class="rounded-2xl border border-black/10 bg-[color:var(--mist)]/60 p-4 text-xs text-black/70">
            <p class="font-semibold text-[color:var(--pine)]">Pagination defaults</p>
            <pre class="mt-3 overflow-x-auto rounded-xl bg-white/80 p-3 text-xs text-[color:var(--pine)]"><code># query params
?page=1&page_size=25</code></pre>
            <p class="mt-2 text-black/50">Max page_size is 100.</p>
          </div>
          <div class="rounded-2xl border border-black/10 bg-white/90 p-4 text-xs text-black/70">
            <p class="font-semibold text-[color:var(--pine)]">Extension points</p>
            <pre class="mt-3 overflow-x-auto rounded-xl bg-[color:var(--mist)] p-3 text-xs text-[color:var(--pine)]"><code>// src/routes/your_router.rs
.set_allowed_methods(...)
.set_method_middleware(...)
fn list_order() -> Option<(Column, Order)>
fn list_apply(query, select) -> Select</code></pre>
          </div>
        </section>

        <section id="filters" class="fade-3 mx-auto mt-14 max-w-3xl space-y-4">
          <p class="text-xs uppercase tracking-[0.3em] text-black/40">Filters</p>
          <h3 class="font-display text-3xl text-[color:var(--pine)]">Flexible filtering with clear syntax.</h3>
          <p class="text-sm text-black/70">
            List endpoints accept query params and can turn them into SQL filters.
            The default mode allows all columns and parses by column type. You can
            switch to an allowlist or deny specific columns in your service.
          </p>
          <div class="rounded-3xl border border-black/10 bg-white/95 p-6 shadow-xl shadow-black/5">
            <p class="text-xs uppercase tracking-[0.3em] text-black/50">Strings</p>
            <pre class="mt-4 overflow-x-auto rounded-2xl bg-[color:var(--mist)] p-4 text-xs text-[color:var(--pine)]"><code># query
name=acme
name=acme*
name=*acme
name=*acme*</code></pre>
            <pre class="mt-3 overflow-x-auto rounded-2xl bg-white/80 p-4 text-xs text-[color:var(--pine)]"><code># terminal
curl "http://localhost:3000/api/todos?name=*acme*"</code></pre>
            <p class="mt-2 text-xs text-black/50">Wildcards are only allowed at the ends.</p>
          </div>
          <div class="rounded-3xl border border-black/10 bg-white/95 p-6 shadow-xl shadow-black/5">
            <p class="text-xs uppercase tracking-[0.3em] text-black/50">Numbers</p>
            <pre class="mt-4 overflow-x-auto rounded-2xl bg-[color:var(--mist)] p-4 text-xs text-[color:var(--pine)]"><code># query
count=>=10
count<10
count=10..25</code></pre>
            <pre class="mt-3 overflow-x-auto rounded-2xl bg-white/80 p-4 text-xs text-[color:var(--pine)]"><code># terminal
curl "http://localhost:3000/api/todos?count=10..25"</code></pre>
            <p class="mt-2 text-xs text-black/50">Ranges require both ends.</p>
          </div>
          <div class="rounded-3xl border border-black/10 bg-white/95 p-6 shadow-xl shadow-black/5">
            <p class="text-xs uppercase tracking-[0.3em] text-black/50">Dates</p>
            <pre class="mt-4 overflow-x-auto rounded-2xl bg-[color:var(--mist)] p-4 text-xs text-[color:var(--pine)]"><code># query
created_at=2025-01-10
created_at=2025-01-10T08:30:00Z
run_at=14:30:00</code></pre>
            <pre class="mt-3 overflow-x-auto rounded-2xl bg-white/80 p-4 text-xs text-[color:var(--pine)]"><code># terminal
curl "http://localhost:3000/api/todos?created_at=2025-01-10"</code></pre>
          </div>
          <div class="rounded-3xl border border-black/10 bg-white/95 p-6 shadow-xl shadow-black/5">
            <p class="text-xs uppercase tracking-[0.3em] text-black/50">Other types</p>
            <pre class="mt-4 overflow-x-auto rounded-2xl bg-[color:var(--mist)] p-4 text-xs text-[color:var(--pine)]"><code># query
active=true
id=550e8400-e29b-41d4-a716-446655440000
meta={"tier":"pro"}</code></pre>
          </div>
          <div class="rounded-2xl border border-black/10 bg-white/90 p-4 text-xs text-black/70">
            <p class="font-semibold text-[color:var(--pine)]">Filter modes</p>
            <pre class="mt-3 overflow-x-auto rounded-xl bg-[color:var(--mist)] p-3 text-xs text-[color:var(--pine)]"><code>// src/services/your_service.rs
fn list_filter_mode() -> FilterMode {
    FilterMode::Allowlist(...)
    // or
    FilterMode::AllColumns { deny: &["internal"], parse: ByColumnType }
}</code></pre>
            <p class="mt-2 text-black/50">Unknown columns return 400. Non-string filters reject wildcards.</p>
          </div>
        </section>

        <section id="next-steps" class="fade-3 mx-auto mt-14 max-w-3xl space-y-4">
          <p class="text-xs uppercase tracking-[0.3em] text-black/40">Next steps</p>
          <div class="rounded-2xl border border-black/10 bg-white/90 p-4 text-sm text-black/70">
            <ol class="list-decimal list-inside space-y-1">
              <li>Implement your service and decide filter mode.</li>
              <li>Mount the CRUD router and add route-level auth if needed.</li>
              <li>Run the example client or curl the new endpoints.</li>
            </ol>
          </div>
        </section>
      </main>
{% endblock %}
