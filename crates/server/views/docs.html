{% extends "base.html" %}

{% block title %}{{ project_name }} Template Documentation{% endblock %}
{% block description %}Template docs for {{ project_name }}: CRUD router setup, filter syntax, and where to extend the stack.{% endblock %}

{% block content %}
      <main class="overflow-x-hidden px-6 pb-16 pt-10 sm:px-10">
        <section class="fade-1 mx-auto max-w-6xl space-y-6">
          <div
            class="inline-flex items-center gap-3 rounded-full border border-black/10 bg-white/80 px-4 py-2 text-xs uppercase tracking-[0.3em] text-black/60 shadow-sm"
          >
            <span class="h-2 w-2 rounded-full bg-[color:var(--clay)]"></span>
            {{ project_name }} docs
          </div>
          <h1 class="font-display text-4xl leading-tight text-[color:var(--pine)] sm:text-5xl">
            {{ project_name }} Template Documentation
          </h1>
          <p class="max-w-3xl text-base text-black/70 sm:text-lg">
            Single-page docs with section-based rendering. Use the sidebar to jump between
            setup, architecture, auth, database, config, routing, logging, error handling, and CLI workflows.
          </p>
        </section>

        <div class="mx-auto mt-10 grid max-w-6xl gap-8 lg:grid-cols-[240px_1fr]">
          <aside class="fade-2 min-w-0">
            <nav class="sticky top-24 hidden border-l border-black/10 pl-4 lg:block">
              <p class="text-xs font-semibold uppercase tracking-[0.28em] text-black/50">On this page</p>
              <div data-doc-nav-desktop class="mt-4 space-y-1 text-sm"></div>
            </nav>

            <div class="mt-4 lg:hidden">
              <button
                type="button"
                data-doc-menu-toggle
                aria-expanded="false"
                aria-controls="docs-mobile-drawer"
                class="inline-flex items-center gap-2 rounded-full border border-black/10 bg-white px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-[color:var(--pine)] shadow-sm transition hover:-translate-y-0.5"
              >
                <svg viewBox="0 0 20 20" aria-hidden="true" class="h-4 w-4">
                  <path
                    d="M3 5h14M3 10h14M3 15h14"
                    fill="none"
                    stroke="currentColor"
                    stroke-linecap="round"
                    stroke-width="1.5"
                  ></path>
                </svg>
                Sections
              </button>
            </div>
          </aside>

          <div class="fade-3 min-w-0 space-y-6">
            <div
              data-doc-pager
              class="flex items-center justify-between"
            >
              <button
                type="button"
                data-doc-prev
                class="rounded-full border border-black/10 bg-white px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-[color:var(--pine)] transition hover:-translate-y-0.5"
              >
                Previous
              </button>
              <button
                type="button"
                data-doc-next
                class="rounded-full border border-black/10 bg-white px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-[color:var(--pine)] transition hover:-translate-y-0.5"
              >
                Next
              </button>
            </div>
            <div data-doc-sections>
              {{ sections_html|safe }}
            </div>
          </div>
        </div>
        <div data-doc-overlay class="fixed inset-0 z-40 hidden bg-black/45 lg:hidden"></div>
        <aside
          id="docs-mobile-drawer"
          data-doc-drawer
          class="fixed inset-y-0 left-0 z-50 box-border w-[min(88vw,22rem)] max-w-full -translate-x-full border-r border-black/10 bg-white px-5 pb-6 pt-5 shadow-2xl transition-transform duration-200 ease-out lg:hidden"
          role="dialog"
          aria-modal="true"
          aria-label="Documentation sections"
        >
          <div class="flex items-center justify-between gap-4 border-b border-black/10 pb-3">
            <p class="text-xs font-semibold uppercase tracking-[0.28em] text-black/50">On this page</p>
            <button
              type="button"
              data-doc-menu-close
              class="rounded-full border border-black/10 bg-[color:var(--mist)] px-3 py-1 text-[10px] font-semibold uppercase tracking-[0.2em] text-[color:var(--pine)]"
            >
              Close
            </button>
          </div>
          <nav class="mt-4">
            <div data-doc-nav-mobile class="space-y-2"></div>
          </nav>
        </aside>
      </main>

      <script>
        (() => {
          let docsState = null;
          const DRAWER_TRANSITION_MS = 200;

          function setManualScrollRestoration() {
            if ("scrollRestoration" in history) {
              history.scrollRestoration = "manual";
            }
          }

          async function copyWithClipboard(text) {
            if (!navigator.clipboard || !navigator.clipboard.writeText) {
              return false;
            }
            try {
              await navigator.clipboard.writeText(text);
              return true;
            } catch {
              return false;
            }
          }

          function copyWithFallback(text) {
            const input = document.createElement("textarea");
            input.value = text;
            input.setAttribute("readonly", "true");
            input.style.position = "absolute";
            input.style.left = "-9999px";
            document.body.appendChild(input);
            input.select();
            let ok = false;
            try {
              ok = document.execCommand("copy");
            } catch {
              ok = false;
            }
            document.body.removeChild(input);
            return ok;
          }

          async function copyText(text) {
            return (await copyWithClipboard(text)) || copyWithFallback(text);
          }

          function showCopied(button) {
            const original = button.textContent;
            button.textContent = "Copied";
            button.disabled = true;
            setTimeout(() => {
              button.textContent = original;
              button.disabled = false;
            }, 1200);
          }

          function attachCopyHandler(button, getText) {
            button.addEventListener("click", async () => {
              const text = getText().trim();
              if (!text) {
                return;
              }
              if (await copyText(text)) {
                showCopied(button);
              }
            });
          }

          function initTerminalCopyButtons() {
            const terminalButtons = document.querySelectorAll("[data-copy-target]");
            for (const button of terminalButtons) {
              const targetId = button.dataset.copyTarget;
              const target = targetId ? document.getElementById(targetId) : null;
              if (!target) {
                continue;
              }
              attachCopyHandler(button, () => target.textContent);
            }
          }

          function createInlineCopyButton() {
            const button = document.createElement("button");
            button.type = "button";
            button.textContent = "Copy";
            button.dataset.copyInline = "true";
            button.className =
              "absolute right-3 top-3 rounded-full border border-black/10 bg-white/80 px-3 py-1 text-[10px] font-semibold uppercase tracking-[0.25em] text-[color:var(--pine)] shadow-sm transition hover:-translate-y-0.5";
            return button;
          }

          function initInlineCodeCopyButtons() {
            const codeBlocks = document.querySelectorAll("pre > code");
            for (const code of codeBlocks) {
              const pre = code.parentElement;
              if (!pre || pre.closest("[data-terminal]")) {
                continue;
              }
              if (pre.querySelector("[data-copy-inline]")) {
                continue;
              }

              pre.classList.add("relative");
              pre.style.paddingTop = "2.5rem";

              const button = createInlineCopyButton();
              pre.appendChild(button);
              attachCopyHandler(button, () => code.textContent);
            }
          }

          function initCopyButtons() {
            initTerminalCopyButtons();
            initInlineCodeCopyButtons();
          }

          function toTitleCase(raw) {
            return raw
              .split("-")
              .filter(Boolean)
              .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
              .join(" ");
          }

          function getSectionTitle(section) {
            const configured = (section.dataset.navTitle || "").trim();
            if (configured) {
              return configured;
            }
            const heading = section.querySelector("h1, h2, h3");
            if (heading && heading.textContent) {
              return heading.textContent.trim();
            }
            return toTitleCase(section.id);
          }

          function createNavLink(section, variant) {
            const link = document.createElement("a");
            link.href = `#${section.id}`;
            link.dataset.docNav = "true";
            link.dataset.navVariant = variant;
            link.textContent = getSectionTitle(section);
            if (variant === "desktop") {
              link.className =
                "doc-nav-link block border-l-2 border-transparent px-3 py-2 text-black/70 transition hover:border-l-[color:var(--pine)] hover:bg-[color:var(--mist)] hover:text-[color:var(--pine)]";
            } else {
              link.className =
                "doc-nav-link block border-l-2 border-transparent px-3 py-3 text-sm font-semibold text-[color:var(--pine)] transition hover:border-l-[color:var(--pine)] hover:bg-[color:var(--mist)]";
            }
            return link;
          }

          function appendNavLinksForVariant(state, container, variant) {
            if (!container) {
              return;
            }
            for (const section of state.sections) {
              const link = createNavLink(section, variant);
              container.appendChild(link);
              state.navLinks.push(link);
            }
          }

          function renderNavLinks(state) {
            appendNavLinksForVariant(state, state.desktopNavContainer, "desktop");
            appendNavLinksForVariant(state, state.mobileNavContainer, "mobile");
          }

          function setActiveNavState(state, id) {
            for (const link of state.navLinks) {
              const href = link.getAttribute("href") || "";
              const isActive = href === `#${id}`;
              const variant = link.dataset.navVariant || "desktop";
              link.setAttribute("aria-current", isActive ? "true" : "false");
              if (variant === "mobile") {
                link.classList.toggle("bg-[color:var(--pine)]", isActive);
                link.classList.toggle("text-white", isActive);
                link.classList.toggle("border-l-[color:var(--pine)]", isActive);
                if (!isActive) {
                  link.classList.remove("bg-[color:var(--pine)]");
                  link.classList.remove("text-white");
                  link.classList.remove("border-l-[color:var(--pine)]");
                }
              } else {
                link.classList.toggle("border-l-[color:var(--pine)]", isActive);
                link.classList.toggle("bg-[color:var(--mist)]", isActive);
                link.classList.toggle("text-[color:var(--pine)]", isActive);
                link.classList.toggle("font-semibold", isActive);
                if (!isActive) {
                  link.classList.remove("border-l-[color:var(--pine)]");
                  link.classList.remove("font-semibold");
                }
              }
            }
          }

          function setDrawerToggleExpanded(state, isExpanded) {
            if (!state.menuToggleButton) {
              return;
            }
            state.menuToggleButton.setAttribute(
              "aria-expanded",
              isExpanded ? "true" : "false"
            );
          }

          function setDrawerScrollLock(locked) {
            document.body.classList.toggle("overflow-hidden", locked);
            document.documentElement.classList.toggle("overflow-hidden", locked);
          }

          function openDrawer(state) {
            if (!state.drawer || !state.overlay || state.isDrawerOpen) {
              return;
            }
            state.isDrawerOpen = true;
            state.overlay.classList.remove("hidden");
            state.drawer.classList.remove("-translate-x-full");
            state.drawer.classList.add("translate-x-0");
            setDrawerToggleExpanded(state, true);
            setDrawerScrollLock(true);
          }

          function closeDrawer(state) {
            if (!state.drawer || !state.overlay) {
              return;
            }
            if (!state.isDrawerOpen) {
              setDrawerToggleExpanded(state, false);
              setDrawerScrollLock(false);
              return;
            }
            state.isDrawerOpen = false;
            state.drawer.classList.remove("translate-x-0");
            state.drawer.classList.add("-translate-x-full");
            setDrawerToggleExpanded(state, false);
            setDrawerScrollLock(false);
            window.setTimeout(() => {
              if (!state.isDrawerOpen && state.overlay) {
                state.overlay.classList.add("hidden");
              }
            }, DRAWER_TRANSITION_MS);
          }

          function toggleDrawer(state) {
            if (!state) {
              return;
            }
            if (state.isDrawerOpen) {
              closeDrawer(state);
              return;
            }
            openDrawer(state);
          }

          function forceWindowTop() {
            window.scrollTo({ top: 0, left: 0, behavior: "auto" });
            requestAnimationFrame(() => {
              window.scrollTo({ top: 0, left: 0, behavior: "auto" });
              requestAnimationFrame(() => {
                window.scrollTo({ top: 0, left: 0, behavior: "auto" });
              });
            });
            setTimeout(() => {
              window.scrollTo({ top: 0, left: 0, behavior: "auto" });
            }, 80);
          }

          function setButtonDisabled(button, disabled) {
            if (!button) {
              return;
            }
            button.disabled = disabled;
            button.setAttribute("aria-disabled", disabled ? "true" : "false");
            button.classList.toggle("opacity-40", disabled);
            button.classList.toggle("cursor-not-allowed", disabled);
          }

          function updatePagerState(state) {
            if (state.sections.length === 0 || state.activeIndex < 0) {
              setButtonDisabled(state.prevButton, true);
              setButtonDisabled(state.nextButton, true);
              return;
            }
            setButtonDisabled(state.prevButton, state.activeIndex <= 0);
            setButtonDisabled(
              state.nextButton,
              state.activeIndex >= state.sections.length - 1
            );
          }

          function setSectionVisibility(state, activeIndex) {
            for (let i = 0; i < state.sections.length; i += 1) {
              const section = state.sections[i];
              const isActive = i === activeIndex;
              section.classList.toggle("hidden", !isActive);
              section.setAttribute("aria-hidden", isActive ? "false" : "true");
            }
          }

          function findSectionIndexById(state, id) {
            return state.sections.findIndex((section) => section.id === id);
          }

          function updateHistoryHash(id, replaceHistory) {
            const targetHash = `#${id}`;
            if (window.location.hash === targetHash) {
              return;
            }
            if (replaceHistory) {
              history.replaceState(null, "", targetHash);
            } else {
              history.pushState(null, "", targetHash);
            }
          }

          function activateSection(state, nextIndex, options = {}) {
            const { scroll = true } = options;
            if (
              state.sections.length === 0 ||
              nextIndex < 0 ||
              nextIndex >= state.sections.length
            ) {
              return;
            }

            state.activeIndex = nextIndex;
            setSectionVisibility(state, state.activeIndex);

            const activeSection = state.sections[state.activeIndex];
            setActiveNavState(state, activeSection.id);
            updatePagerState(state);

            if (scroll) {
              forceWindowTop();
            }
          }

          function goToSection(state, id, options = {}) {
            const {
              scroll = true,
              updateHistory = true,
              replaceHistory = false,
            } = options;
            const targetIndex = findSectionIndexById(state, id);
            if (targetIndex < 0) {
              return;
            }
            if (updateHistory) {
              updateHistoryHash(id, replaceHistory);
            }
            activateSection(state, targetIndex, { scroll });
          }

          function goRelative(state, offset) {
            const targetIndex = state.activeIndex + offset;
            if (targetIndex < 0 || targetIndex >= state.sections.length) {
              return;
            }
            goToSection(state, state.sections[targetIndex].id);
          }

          function getHashId() {
            return window.location.hash.replace("#", "");
          }

          function syncFromLocation(state, options = {}) {
            const { scroll = true } = options;
            if (state.sections.length === 0) {
              updatePagerState(state);
              return;
            }
            const hashId = getHashId();
            const hashIndex = hashId ? findSectionIndexById(state, hashId) : -1;
            if (hashIndex >= 0) {
              activateSection(state, hashIndex, { scroll });
              return;
            }
            goToSection(state, state.sections[0].id, {
              scroll,
              updateHistory: true,
              replaceHistory: true,
            });
            forceWindowTop();
          }

          function hidePagerWhenNotNeeded(state) {
            if (state.pager && state.sections.length <= 1) {
              state.pager.classList.add("hidden");
            }
          }

          function handleNavLinkClick(event) {
            event.preventDefault();
            if (!docsState) {
              return;
            }
            const target = event.currentTarget;
            if (!(target instanceof HTMLAnchorElement)) {
              return;
            }
            const href = target.getAttribute("href") || "";
            const id = href.replace(/^#/, "");
            const variant = target.dataset.navVariant || "";
            if (id) {
              goToSection(docsState, id);
            }
            if (variant === "mobile") {
              closeDrawer(docsState);
            }
          }

          function handlePrevButtonClick() {
            if (!docsState) {
              return;
            }
            goRelative(docsState, -1);
          }

          function handleNextButtonClick() {
            if (!docsState) {
              return;
            }
            goRelative(docsState, 1);
          }

          function handleLocationChanged() {
            if (!docsState) {
              return;
            }
            if (docsState.isDrawerOpen) {
              closeDrawer(docsState);
            }
            syncFromLocation(docsState, { scroll: true });
          }

          function handleMenuToggleClick(event) {
            event.preventDefault();
            if (!docsState) {
              return;
            }
            toggleDrawer(docsState);
          }

          function handleMenuCloseClick(event) {
            event.preventDefault();
            if (!docsState) {
              return;
            }
            closeDrawer(docsState);
          }

          function handleOverlayClick() {
            if (!docsState) {
              return;
            }
            closeDrawer(docsState);
          }

          function handleDocumentPointerDown(event) {
            if (!docsState || !docsState.isDrawerOpen) {
              return;
            }
            const target = event.target;
            if (!(target instanceof Node)) {
              return;
            }
            if (docsState.drawer && docsState.drawer.contains(target)) {
              return;
            }
            if (
              docsState.menuToggleButton &&
              docsState.menuToggleButton.contains(target)
            ) {
              return;
            }
            closeDrawer(docsState);
          }

          function handleEscapeKeyDown(event) {
            if (!docsState || !docsState.isDrawerOpen) {
              return;
            }
            if (event.key !== "Escape") {
              return;
            }
            closeDrawer(docsState);
          }

          function handleViewportResize() {
            if (!docsState) {
              return;
            }
            if (window.matchMedia("(min-width: 1024px)").matches) {
              closeDrawer(docsState);
            }
          }

          function bindNavEvents(state) {
            for (const link of state.navLinks) {
              link.addEventListener("click", handleNavLinkClick);
            }
          }

          function bindPagerEvents(state) {
            if (state.prevButton) {
              state.prevButton.addEventListener("click", handlePrevButtonClick);
            }
            if (state.nextButton) {
              state.nextButton.addEventListener("click", handleNextButtonClick);
            }
          }

          function bindLocationEvents() {
            window.addEventListener("hashchange", handleLocationChanged);
            window.addEventListener("popstate", handleLocationChanged);
          }

          function bindDrawerEvents(state) {
            if (state.menuToggleButton) {
              state.menuToggleButton.addEventListener(
                "click",
                handleMenuToggleClick
              );
            }
            if (state.menuCloseButton) {
              state.menuCloseButton.addEventListener("click", handleMenuCloseClick);
            }
            if (state.overlay) {
              state.overlay.addEventListener("click", handleOverlayClick);
            }
            document.addEventListener("pointerdown", handleDocumentPointerDown);
            document.addEventListener("keydown", handleEscapeKeyDown);
            window.addEventListener("resize", handleViewportResize);
          }

          function createDocsState() {
            return {
              desktopNavContainer: document.querySelector("[data-doc-nav-desktop]"),
              mobileNavContainer: document.querySelector("[data-doc-nav-mobile]"),
              menuToggleButton: document.querySelector("[data-doc-menu-toggle]"),
              menuCloseButton: document.querySelector("[data-doc-menu-close]"),
              overlay: document.querySelector("[data-doc-overlay]"),
              drawer: document.querySelector("[data-doc-drawer]"),
              pager: document.querySelector("[data-doc-pager]"),
              prevButton: document.querySelector("[data-doc-prev]"),
              nextButton: document.querySelector("[data-doc-next]"),
              sections: Array.from(document.querySelectorAll(".doc-section[id]")),
              navLinks: [],
              activeIndex: -1,
              isDrawerOpen: false,
            };
          }

          function initDocsNavigation() {
            docsState = createDocsState();
            closeDrawer(docsState);
            renderNavLinks(docsState);
            bindNavEvents(docsState);
            bindPagerEvents(docsState);
            bindDrawerEvents(docsState);
            hidePagerWhenNotNeeded(docsState);

            if (docsState.sections.length > 0) {
              syncFromLocation(docsState, { scroll: false });
            } else {
              updatePagerState(docsState);
            }

            bindLocationEvents();
          }

          function initDocsPage() {
            setManualScrollRestoration();
            initCopyButtons();
            initDocsNavigation();
          }

          initDocsPage();
        })();
      </script>
{% endblock %}
