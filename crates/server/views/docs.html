{% extends "base.html" %}

{% block title %}{{ project_name }} Template Documentation{% endblock %}
{% block description %}Template docs for {{ project_name }}: CRUD router setup, filter syntax, and where to extend the stack.{% endblock %}

{% block content %}
      <main class="px-6 pb-16 pt-10 sm:px-10">
        <section class="fade-1 mx-auto max-w-6xl space-y-6">
          <div
            class="inline-flex items-center gap-3 rounded-full border border-black/10 bg-white/80 px-4 py-2 text-xs uppercase tracking-[0.3em] text-black/60 shadow-sm"
          >
            <span class="h-2 w-2 rounded-full bg-[color:var(--clay)]"></span>
            {{ project_name }} docs
          </div>
          <h1 class="font-display text-4xl leading-tight text-[color:var(--pine)] sm:text-5xl">
            {{ project_name }} Template Documentation
          </h1>
          <p class="max-w-3xl text-base text-black/70 sm:text-lg">
            Single-page docs with section-based rendering. Use the sidebar to jump between
            setup, architecture, auth, CRUD, filters, and CLI workflows.
          </p>
        </section>

        <div class="mx-auto mt-10 grid max-w-6xl gap-8 lg:grid-cols-[240px_1fr]">
          <aside class="fade-2">
            <nav class="sticky top-24 hidden rounded-3xl border border-black/10 bg-white/90 p-5 shadow-lg shadow-black/5 lg:block">
              <p class="text-xs font-semibold uppercase tracking-[0.28em] text-black/50">On this page</p>
              <div data-doc-nav-desktop class="mt-4 space-y-1 text-sm"></div>
            </nav>

            <div class="mt-4 overflow-x-auto pb-1 lg:hidden">
              <div data-doc-nav-mobile class="flex min-w-max gap-2 text-xs"></div>
            </div>
          </aside>

          <div class="fade-3">
            {{ sections_html|safe }}
          </div>
        </div>
      </main>

      <script>
        (() => {
          const copyWithClipboard = async (text) => {
            if (!navigator.clipboard || !navigator.clipboard.writeText) {
              return false;
            }
            try {
              await navigator.clipboard.writeText(text);
              return true;
            } catch {
              return false;
            }
          };

          const copyWithFallback = (text) => {
            const input = document.createElement("textarea");
            input.value = text;
            input.setAttribute("readonly", "true");
            input.style.position = "absolute";
            input.style.left = "-9999px";
            document.body.appendChild(input);
            input.select();
            let ok = false;
            try {
              ok = document.execCommand("copy");
            } catch {
              ok = false;
            }
            document.body.removeChild(input);
            return ok;
          };

          const showCopied = (button) => {
            const original = button.textContent;
            button.textContent = "Copied";
            button.disabled = true;
            setTimeout(() => {
              button.textContent = original;
              button.disabled = false;
            }, 1200);
          };

          const attachCopyHandler = (button, getText) => {
            button.addEventListener("click", async () => {
              const text = getText().trim();
              if (!text) {
                return;
              }
              const copied =
                (await copyWithClipboard(text)) || copyWithFallback(text);
              if (copied) {
                showCopied(button);
              }
            });
          };

          const terminalButtons = document.querySelectorAll("[data-copy-target]");
          terminalButtons.forEach((button) => {
            const targetId = button.dataset.copyTarget;
            const target = targetId ? document.getElementById(targetId) : null;
            if (!target) {
              return;
            }
            attachCopyHandler(button, () => target.textContent);
          });

          const codeBlocks = document.querySelectorAll("pre > code");
          codeBlocks.forEach((code) => {
            const pre = code.parentElement;
            if (!pre || pre.closest("[data-terminal]")) {
              return;
            }
            if (pre.querySelector("[data-copy-inline]")) {
              return;
            }
            pre.classList.add("relative");
            pre.style.paddingTop = "2.5rem";

            const button = document.createElement("button");
            button.type = "button";
            button.textContent = "Copy";
            button.dataset.copyInline = "true";
            button.className =
              "absolute right-3 top-3 rounded-full border border-black/10 bg-white/80 px-3 py-1 text-[10px] font-semibold uppercase tracking-[0.25em] text-[color:var(--pine)] shadow-sm transition hover:-translate-y-0.5";
            pre.appendChild(button);
            attachCopyHandler(button, () => code.textContent);
          });

          const desktopNavContainer = document.querySelector("[data-doc-nav-desktop]");
          const mobileNavContainer = document.querySelector("[data-doc-nav-mobile]");
          const sections = Array.from(document.querySelectorAll(".doc-section[id]"));

          const toTitleCase = (raw) =>
            raw
              .split("-")
              .filter(Boolean)
              .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
              .join(" ");

          const sectionTitle = (section) => {
            const configured = (section.dataset.navTitle || "").trim();
            if (configured) {
              return configured;
            }
            const heading = section.querySelector("h1, h2, h3");
            if (heading && heading.textContent) {
              return heading.textContent.trim();
            }
            return toTitleCase(section.id);
          };

          const createNavLink = (section, variant) => {
            const link = document.createElement("a");
            link.href = `#${section.id}`;
            link.dataset.docNav = "true";
            link.dataset.navVariant = variant;
            link.textContent = sectionTitle(section);
            if (variant === "desktop") {
              link.className =
                "doc-nav-link block rounded-lg px-3 py-2 text-black/70 transition hover:bg-[color:var(--mist)] hover:text-[color:var(--pine)]";
            } else {
              link.className =
                "doc-nav-link whitespace-nowrap rounded-full border border-black/10 bg-white/90 px-3 py-2 font-semibold uppercase tracking-[0.2em] text-[color:var(--pine)] transition";
            }
            return link;
          };

          if (desktopNavContainer) {
            sections.forEach((section) => {
              desktopNavContainer.appendChild(createNavLink(section, "desktop"));
            });
          }
          if (mobileNavContainer) {
            sections.forEach((section) => {
              mobileNavContainer.appendChild(createNavLink(section, "mobile"));
            });
          }

          const navLinks = Array.from(document.querySelectorAll("[data-doc-nav]"));

          const setActiveSection = (id) => {
            navLinks.forEach((link) => {
              const href = link.getAttribute("href") || "";
              const isActive = href === `#${id}`;
              const variant = link.dataset.navVariant || "desktop";
              link.setAttribute("aria-current", isActive ? "true" : "false");
              if (variant === "mobile") {
                link.classList.toggle("bg-[color:var(--pine)]", isActive);
                link.classList.toggle("text-white", isActive);
                link.classList.toggle("border-[color:var(--pine)]", isActive);
                if (!isActive) {
                  link.classList.remove("bg-[color:var(--pine)]");
                  link.classList.remove("text-white");
                  link.classList.remove("border-[color:var(--pine)]");
                }
              } else {
                link.classList.toggle("bg-[color:var(--mist)]", isActive);
                link.classList.toggle("text-[color:var(--pine)]", isActive);
                link.classList.toggle("font-semibold", isActive);
                if (!isActive) {
                  link.classList.remove("font-semibold");
                }
              }
            });
          };

          const hashId = window.location.hash.replace("#", "");
          if (hashId) {
            setActiveSection(hashId);
          } else if (sections.length > 0) {
            setActiveSection(sections[0].id);
          }

          const findActiveSection = () => {
            if (sections.length === 0) {
              return null;
            }

            const marker = 160;
            const atBottom =
              window.innerHeight + window.scrollY >=
              document.documentElement.scrollHeight - 2;
            if (atBottom) {
              return sections[sections.length - 1].id;
            }

            let activeId = sections[0].id;
            for (const section of sections) {
              const top = section.getBoundingClientRect().top;
              if (top <= marker) {
                activeId = section.id;
              } else {
                break;
              }
            }
            return activeId;
          };

          let scrollTicking = false;
          const syncNavToScroll = () => {
            if (scrollTicking) {
              return;
            }
            scrollTicking = true;
            requestAnimationFrame(() => {
              const activeId = findActiveSection();
              if (activeId) {
                setActiveSection(activeId);
              }
              scrollTicking = false;
            });
          };

          window.addEventListener("scroll", syncNavToScroll, { passive: true });
          window.addEventListener("resize", syncNavToScroll);
          syncNavToScroll();

          window.addEventListener("hashchange", () => {
            const id = window.location.hash.replace("#", "");
            if (id) {
              setActiveSection(id);
            } else {
              syncNavToScroll();
            }
          });
        })();
      </script>
{% endblock %}
